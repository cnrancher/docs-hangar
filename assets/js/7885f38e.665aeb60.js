"use strict";(self.webpackChunkdocs_hangar=self.webpackChunkdocs_hangar||[]).push([[5046],{6612:(e,r,s)=>{s.r(r),s.d(r,{assets:()=>c,contentTitle:()=>t,default:()=>h,frontMatter:()=>a,metadata:()=>o,toc:()=>l});var n=s(5893),i=s(1151);const a={title:"K3s Air-Gapped Installation"},t=void 0,o={id:"bestpractice/k3s",title:"K3s Air-Gapped Installation",description:"This example will guide you to setup a multi-arch private image registry server for K3s for Air-Gapped installation.",source:"@site/versioned_docs/version-v1.7/20-bestpractice/02-k3s.md",sourceDirName:"20-bestpractice",slug:"/bestpractice/k3s",permalink:"/v1.7/bestpractice/k3s",draft:!1,unlisted:!1,editUrl:"https://github.com/cnrancher/docs-hangar/edit/main/versioned_docs/version-v1.7/20-bestpractice/02-k3s.md",tags:[],version:"v1.7",sidebarPosition:2,frontMatter:{title:"K3s Air-Gapped Installation"},sidebar:"docs",previous:{title:"Rancher Air-Gap Installation",permalink:"/v1.7/bestpractice/rancher"},next:{title:"RKE2 Air-Gap Installation",permalink:"/v1.7/bestpractice/rke2"}},c={},l=[{value:"Best Practice",id:"best-practice",level:2}];function d(e){const r={a:"a",admonition:"admonition",blockquote:"blockquote",code:"code",h2:"h2",li:"li",ol:"ol",p:"p",pre:"pre",...(0,i.a)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(r.p,{children:"This example will guide you to setup a multi-arch private image registry server for K3s for Air-Gapped installation."}),"\n",(0,n.jsxs)(r.p,{children:["You can use the ",(0,n.jsx)(r.a,{href:"https://docs.k3s.io/installation/airgap#private-registry-method",children:"Private Registry Method"})," to prepare the private image registry server used by K3s."]}),"\n",(0,n.jsx)(r.h2,{id:"best-practice",children:"Best Practice"}),"\n",(0,n.jsxs)(r.ol,{children:["\n",(0,n.jsxs)(r.li,{children:["\n",(0,n.jsxs)(r.p,{children:["Setup a private ",(0,n.jsx)(r.a,{href:"https://distribution.github.io/distribution/",children:"registry"})," server to host the container images used by K3s."]}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-sh",children:"#!/bin/bash\n\n# In this example, we create a directory to store the container image layers.\nmkdir -p registry\n\ndocker run -d \\\n    -p 5000:5000 \\\n    -v $(pwd)/registry:/var/lib/registry \\\n    --name registry \\\n    registry:2\n"})}),"\n",(0,n.jsx)(r.p,{children:"Login to the private image registry."}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-sh",children:"hangar login '127.0.0.1:5000'\n"})}),"\n",(0,n.jsxs)(r.admonition,{type:"note",children:[(0,n.jsx)(r.p,{children:"By default, the registry server can be login with any username and password."}),(0,n.jsxs)(r.p,{children:["You can configure the authentication config of the registry server by refer to ",(0,n.jsx)(r.a,{href:"https://distribution.github.io/distribution/spec/auth/",children:"Distribution Registry Token Authentication"}),"."]})]}),"\n"]}),"\n",(0,n.jsxs)(r.li,{children:["\n",(0,n.jsxs)(r.p,{children:["Download the K3s image list file from ",(0,n.jsx)(r.a,{href:"https://github.com/k3s-io/k3s/releases/",children:"K3s GitHub Release"})," page."]}),"\n",(0,n.jsxs)(r.blockquote,{children:["\n",(0,n.jsxs)(r.p,{children:["We use version ",(0,n.jsx)(r.code,{children:"v1.27.6+k3s1"})," in this example."]}),"\n"]}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-sh",children:"wget 'https://github.com/k3s-io/k3s/releases/download/v1.27.6%2Bk3s1/k3s-images.txt'\n"})}),"\n"]}),"\n",(0,n.jsxs)(r.li,{children:["\n",(0,n.jsxs)(r.p,{children:["If the private image registry has the ability to access Docker Hub registry server, use Hangar ",(0,n.jsx)(r.a,{href:"/v1.7/mirror/mirror",children:"mirror"})," command to mirror both ",(0,n.jsx)(r.code,{children:"amd64"})," and ",(0,n.jsx)(r.code,{children:"arm64"})," container images from Docker Hub to your private image registry."]}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-sh",children:"#!/bin/bash\n\nhangar mirror \\\n    -f 'k3s-images.txt' \\\n    -s 'docker.io' \\\n    -d 'localhost:5000' \\\n    --arch 'amd64,arm64' \\\n    --os 'linux' \\\n    --jobs 5 \\\n    --tls-verify=false\n"})}),"\n",(0,n.jsxs)(r.p,{children:["Use the Hangar ",(0,n.jsx)(r.a,{href:"/v1.7/mirror/validate",children:"mirror validate"})," command to verify the copied container images if necessary."]}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-sh",children:"#!/bin/bash\n\nhangar mirror validate \\\n    -f 'k3s-images.txt' \\\n    -s 'docker.io' \\\n    -d 'localhost:5000' \\\n    --arch 'amd64,arm64' \\\n    --os 'linux' \\\n    --jobs 5 \\\n    --tls-verify=false\n"})}),"\n"]}),"\n",(0,n.jsxs)(r.li,{children:["\n",(0,n.jsxs)(r.p,{children:["If the private image registry server can't access Docker Hub, use ",(0,n.jsx)(r.a,{href:"/v1.7/save/save",children:"hangar save"})," and ",(0,n.jsx)(r.a,{href:"/v1.7/load/load",children:"hangar load"})," command to copy container image to the private registry server."]}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-sh",children:"#!/bin/bash\n\n# Save images into k3s-images.zip\nhangar save \\\n    -f 'k3s-images.txt' \\\n    -s 'docker.io' \\\n    -d 'k3s-images.zip' \\\n    --arch 'amd64,arm64' \\\n    --os 'linux' \\\n    --jobs 5\n"})}),"\n",(0,n.jsxs)(r.p,{children:["The saved ",(0,n.jsx)(r.code,{children:"k3s-images.zip"})," archive file contains both ",(0,n.jsx)(r.code,{children:"amd64"})," and ",(0,n.jsx)(r.code,{children:"arm64"})," container images."]}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-sh",children:"#!/bin/bash\n\n# Load images from k3s-images.zip to the private image registry server.\nhangar load \\\n    -s 'k3s-images.zip' \\\n    -d 'localhost:5000' \\\n    --arch 'amd64,arm64' \\\n    --os 'linux' \\\n    --jobs 5 \\\n    --tls-verify=false\n"})}),"\n"]}),"\n",(0,n.jsxs)(r.li,{children:["\n",(0,n.jsxs)(r.p,{children:["Create the ",(0,n.jsx)(r.code,{children:"/etc/rancher/k3s/registries.yaml"})," configuration file by refer to ",(0,n.jsx)(r.a,{href:"https://docs.k3s.io/installation/private-registry",children:"Private Registry Configuration"}),"."]}),"\n",(0,n.jsx)(r.admonition,{type:"note",children:(0,n.jsxs)(r.p,{children:["In this example, we assume that the private image registry IP address was bind to the URL ",(0,n.jsx)(r.code,{children:"private.io"}),"."]})}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-sh",children:"mkdir -p /etc/rancher/k3s\n"})}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-yaml",metastring:'title="/etc/rancher/k3s/registries.yaml"',children:'mirrors:\n    docker.io:\n        endpoint:\n        - "http://private.io:5000"\n    "private.io:5000":\n        endpoint:\n        - "http://private.io:5000"\n'})}),"\n"]}),"\n",(0,n.jsxs)(r.li,{children:["\n",(0,n.jsxs)(r.p,{children:["Install K3s by refer to the guide of ",(0,n.jsx)(r.a,{href:"https://docs.k3s.io/installation/airgap#install-k3s",children:"Air Gap install K3s"}),"."]}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-sh",children:"export INSTALL_K3S_SKIP_DOWNLOAD=true\n./install.sh\n"})}),"\n",(0,n.jsxs)(r.p,{children:["You can execute following command to pull images from the private image registry server to ensure that the ",(0,n.jsx)(r.code,{children:"registries.yaml"})," config is working properly:"]}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-sh",children:"k3s crictl pull private.io:5000/rancher/mirrored-pause:3.6\n"})}),"\n"]}),"\n"]})]})}function h(e={}){const{wrapper:r}={...(0,i.a)(),...e.components};return r?(0,n.jsx)(r,{...e,children:(0,n.jsx)(d,{...e})}):d(e)}},1151:(e,r,s)=>{s.d(r,{Z:()=>o,a:()=>t});var n=s(7294);const i={},a=n.createContext(i);function t(e){const r=n.useContext(a);return n.useMemo((function(){return"function"==typeof e?e(r):{...r,...e}}),[r,e])}function o(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:t(e.components),n.createElement(a.Provider,{value:r},e.children)}}}]);